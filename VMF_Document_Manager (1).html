<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VM Federation - Document Manager</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #E86825;
            --secondary: #1B4332;
            --dark: #2c3e50;
            --light: #f8f9fa;
            --border: #dee2e6;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 240px;
            height: 100vh;
            background: var(--secondary);
            padding: 20px 0;
            z-index: 100;
        }
        
        .sidebar-logo {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 20px;
        }
        
        .sidebar-logo h1 {
            color: #fff;
            font-size: 16px;
            font-weight: 600;
        }
        
        .sidebar-logo p {
            color: var(--primary);
            font-size: 11px;
            margin-top: 2px;
        }
        
        .sidebar-menu { list-style: none; }
        
        .sidebar-menu li a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .sidebar-menu li a:hover,
        .sidebar-menu li a.active {
            background: rgba(255,255,255,0.1);
            color: #fff;
            border-left: 3px solid var(--primary);
        }
        
        .sidebar-menu li a .icon { font-size: 18px; }
        
        .sidebar-menu li a .badge {
            margin-left: auto;
            background: var(--primary);
            color: #fff;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
        }
        
        /* Main Content */
        .main-content {
            margin-left: 240px;
            padding: 20px 30px;
            min-height: 100vh;
        }
        
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .page-header h2 {
            color: var(--dark);
            font-size: 22px;
            font-weight: 600;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }
        
        .btn-primary { background: var(--primary); color: #fff; }
        .btn-primary:hover { background: #d55a1a; }
        
        .btn-secondary { background: var(--secondary); color: #fff; }
        .btn-secondary:hover { background: #153a28; }
        
        .btn-outline { background: #fff; border: 1px solid var(--border); color: var(--dark); }
        .btn-outline:hover { background: var(--light); }
        
        .btn-sm { padding: 6px 12px; font-size: 13px; }
        
        .btn-icon {
            width: 32px;
            height: 32px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
        }
        
        /* Cards */
        .card {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .card-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-header h3 {
            font-size: 15px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .card-body { padding: 20px; }
        
        /* Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th {
            text-align: left;
            padding: 12px 15px;
            background: var(--light);
            color: #6c757d;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--border);
        }
        
        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
            color: var(--dark);
        }
        
        .data-table tr:hover { background: #f8f9fa; }
        
        .data-table .doc-number {
            font-weight: 600;
            color: var(--primary);
        }
        
        .data-table .status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-draft { background: #e9ecef; color: #6c757d; }
        .status-sent { background: #cce5ff; color: #004085; }
        .status-confirmed { background: #d4edda; color: #155724; }
        .status-cancelled { background: #f8d7da; color: #721c24; }
        
        .actions-cell {
            display: flex;
            gap: 5px;
        }
        
        /* Form Styles */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-group { margin-bottom: 15px; }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 13px;
            font-weight: 500;
            color: #495057;
        }
        
        .form-group label .required { color: var(--danger); }
        
        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(232, 104, 37, 0.1);
        }
        
        select.form-control {
            appearance: none;
            background: #fff url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%236c757d' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E") no-repeat right 12px center;
            cursor: pointer;
        }
        
        textarea.form-control { resize: vertical; min-height: 80px; }
        
        .form-control-sm { padding: 6px 10px; font-size: 13px; }
        
        /* Section Title */
        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--dark);
            margin: 25px 0 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-title:first-child { margin-top: 0; }
        
        /* Document Preview Header */
        .doc-preview-header {
            background: linear-gradient(135deg, var(--secondary) 0%, #0d2818 100%);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .doc-preview-header .doc-type {
            color: rgba(255,255,255,0.7);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .doc-preview-header .doc-number-input {
            background: transparent;
            border: 1px dashed rgba(255,255,255,0.3);
            color: var(--primary);
            font-size: 24px;
            font-weight: 700;
            font-family: inherit;
            padding: 5px 10px;
            border-radius: 6px;
            width: 220px;
        }
        
        .doc-preview-header .doc-number-input:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(255,255,255,0.1);
        }
        
        .doc-preview-header .doc-status select {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: #fff;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-family: inherit;
        }
        
        /* Items Table */
        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        .items-table th {
            background: var(--secondary);
            color: #fff;
            padding: 10px 12px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
        }
        
        .items-table td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
            vertical-align: top;
        }
        
        .items-table input,
        .items-table textarea,
        .items-table select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 13px;
            font-family: inherit;
        }
        
        .items-table .num-input { width: 80px; text-align: right; }
        .items-table .amount-cell { font-weight: 600; color: var(--secondary); text-align: right; }
        
        .btn-add-row {
            width: 100%;
            padding: 12px;
            background: #f8f9fa;
            border: 2px dashed var(--border);
            color: #6c757d;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-add-row:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: #fff5f0;
        }
        
        /* Totals */
        .totals-section {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        .totals-box {
            background: var(--light);
            padding: 15px 20px;
            border-radius: 8px;
            min-width: 280px;
        }
        
        .totals-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 14px;
        }
        
        .totals-row.grand {
            border-top: 2px solid var(--dark);
            margin-top: 8px;
            padding-top: 10px;
            font-weight: 700;
            font-size: 16px;
            color: var(--primary);
        }
        
        /* Client Info Box */
        .client-info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196f3;
            padding: 12px 15px;
            border-radius: 0 8px 8px 0;
            margin-top: 10px;
        }
        
        .client-info-box p {
            font-size: 13px;
            color: #495057;
            margin: 3px 0;
        }
        
        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-overlay.show { display: flex; }
        
        .modal {
            background: #fff;
            border-radius: 12px;
            width: 95%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: #fff;
            z-index: 10;
        }
        
        .modal-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #6c757d;
            cursor: pointer;
        }
        
        .modal-body { padding: 20px; }
        
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            position: sticky;
            bottom: 0;
            background: #fff;
        }
        
        /* Search & Filter */
        .toolbar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .search-box {
            flex: 1;
            min-width: 200px;
            position: relative;
        }
        
        .search-box input {
            width: 100%;
            padding: 10px 12px 10px 40px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }
        
        .search-box::before {
            content: 'üîç';
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .filter-group {
            display: flex;
            gap: 10px;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border);
            padding-bottom: 0;
        }
        
        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: none;
            color: #6c757d;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            font-family: inherit;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }
        
        .tab-btn:hover { color: var(--dark); }
        
        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        
        /* Stats Cards */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: #fff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .stat-card .label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-card .value {
            font-size: 28px;
            font-weight: 700;
            color: var(--dark);
            margin-top: 5px;
        }
        
        .stat-card .change {
            font-size: 12px;
            margin-top: 5px;
        }
        
        .stat-card .change.positive { color: var(--success); }
        .stat-card .change.negative { color: var(--danger); }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }
        
        .empty-state .icon { font-size: 48px; margin-bottom: 15px; }
        .empty-state h4 { font-size: 18px; margin-bottom: 8px; color: var(--dark); }
        .empty-state p { font-size: 14px; margin-bottom: 20px; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .main-content { margin-left: 0; }
            .form-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-logo">
            <h1>VM Federation</h1>
            <p>Document Manager</p>
        </div>
        <ul class="sidebar-menu">
            <li><a href="#" class="active" onclick="showPage('dashboard')"><span class="icon">üìä</span> Dashboard</a></li>
            <li><a href="#" onclick="showPage('quotations')"><span class="icon">üìã</span> Quotations <span class="badge" id="quoteCount">0</span></a></li>
            <li><a href="#" onclick="showPage('salesorders')"><span class="icon">üì¶</span> Sales Orders <span class="badge" id="soCount">0</span></a></li>
            <li><a href="#" onclick="showPage('clients')"><span class="icon">üë•</span> Clients</a></li>
            <li><a href="#" onclick="showPage('products')"><span class="icon">üì¶</span> Products</a></li>
            <li><a href="#" onclick="showPage('settings')"><span class="icon">‚öôÔ∏è</span> Settings</a></li>
        </ul>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Dashboard Page -->
        <div id="page-dashboard" class="page">
            <div class="page-header">
                <h2>Dashboard</h2>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="openNewDocument('quote')">+ New Quotation</button>
                    <button class="btn btn-secondary" onclick="openNewDocument('so')">+ New Sales Order</button>
                </div>
            </div>
            
            <div class="stats-row">
                <div class="stat-card">
                    <div class="label">Total Quotations</div>
                    <div class="value" id="statQuotes">0</div>
                </div>
                <div class="stat-card">
                    <div class="label">Total Sales Orders</div>
                    <div class="value" id="statSOs">0</div>
                </div>
                <div class="stat-card">
                    <div class="label">This Month Revenue</div>
                    <div class="value" id="statRevenue">$0</div>
                </div>
                <div class="stat-card">
                    <div class="label">Pending Confirmation</div>
                    <div class="value" id="statPending">0</div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h3>Recent Documents</h3>
                    <button class="btn btn-outline btn-sm" onclick="showPage('quotations')">View All</button>
                </div>
                <div class="card-body" style="padding: 0;">
                    <table class="data-table" id="recentDocsTable">
                        <thead>
                            <tr>
                                <th>Document #</th>
                                <th>Type</th>
                                <th>Client</th>
                                <th>Amount</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Quotations Page -->
        <div id="page-quotations" class="page" style="display: none;">
            <div class="page-header">
                <h2>Quotations</h2>
                <button class="btn btn-primary" onclick="openNewDocument('quote')">+ New Quotation</button>
            </div>
            
            <div class="toolbar">
                <div class="search-box">
                    <input type="text" placeholder="Search quotations..." id="searchQuotes" onkeyup="filterDocuments('quote')">
                </div>
                <div class="filter-group">
                    <select class="form-control" style="width: 150px;" id="filterQuoteStatus" onchange="filterDocuments('quote')">
                        <option value="">All Status</option>
                        <option value="draft">Draft</option>
                        <option value="sent">Sent</option>
                        <option value="confirmed">Confirmed</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
            </div>
            
            <div class="card">
                <div class="card-body" style="padding: 0;">
                    <table class="data-table" id="quotationsTable">
                        <thead>
                            <tr>
                                <th>Quote #</th>
                                <th>Client</th>
                                <th>Amount</th>
                                <th>Date</th>
                                <th>Valid Till</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Sales Orders Page -->
        <div id="page-salesorders" class="page" style="display: none;">
            <div class="page-header">
                <h2>Sales Orders</h2>
                <button class="btn btn-primary" onclick="openNewDocument('so')">+ New Sales Order</button>
            </div>
            
            <div class="toolbar">
                <div class="search-box">
                    <input type="text" placeholder="Search sales orders..." id="searchSOs" onkeyup="filterDocuments('so')">
                </div>
                <div class="filter-group">
                    <select class="form-control" style="width: 150px;" id="filterSOStatus" onchange="filterDocuments('so')">
                        <option value="">All Status</option>
                        <option value="draft">Draft</option>
                        <option value="confirmed">Confirmed</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
            </div>
            
            <div class="card">
                <div class="card-body" style="padding: 0;">
                    <table class="data-table" id="salesOrdersTable">
                        <thead>
                            <tr>
                                <th>SO #</th>
                                <th>Client</th>
                                <th>Customer PO</th>
                                <th>Amount</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Clients Page -->
        <div id="page-clients" class="page" style="display: none;">
            <div class="page-header">
                <h2>Clients</h2>
                <button class="btn btn-primary" onclick="openClientModal()">+ Add Client</button>
            </div>
            
            <div class="card">
                <div class="card-body" style="padding: 0;">
                    <table class="data-table" id="clientsTable">
                        <thead>
                            <tr>
                                <th>Company Name</th>
                                <th>Contact Person</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Products Page -->
        <div id="page-products" class="page" style="display: none;">
            <div class="page-header">
                <h2>Products</h2>
                <button class="btn btn-primary" onclick="openProductModal()">+ Add Product</button>
            </div>
            
            <div class="card">
                <div class="card-body" style="padding: 0;">
                    <table class="data-table" id="productsTable">
                        <thead>
                            <tr>
                                <th>Product Name</th>
                                <th>Description</th>
                                <th>Unit Price</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Settings Page -->
        <div id="page-settings" class="page" style="display: none;">
            <div class="page-header">
                <h2>Settings</h2>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h3>Techflouu CRM Integration</h3>
                </div>
                <div class="card-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label>API Key</label>
                            <input type="text" class="form-control" id="settingsApiKey" placeholder="Enter Techflouu API Key">
                        </div>
                        <div class="form-group">
                            <label>Location ID</label>
                            <input type="text" class="form-control" id="settingsLocationId" placeholder="Enter Location ID">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>n8n Webhook URL (Optional)</label>
                        <input type="text" class="form-control" id="settingsWebhook" placeholder="https://your-n8n.com/webhook/...">
                    </div>
                    <button class="btn btn-primary" onclick="saveSettings()">Save & Sync Clients</button>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h3>Document Numbering</h3>
                </div>
                <div class="card-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Next Quote Number</label>
                            <input type="number" class="form-control" id="settingsQuoteNum" placeholder="1477">
                        </div>
                        <div class="form-group">
                            <label>Next SO Number</label>
                            <input type="number" class="form-control" id="settingsSONum" placeholder="1">
                        </div>
                    </div>
                    <button class="btn btn-secondary" onclick="saveNumbering()">Update Numbering</button>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h3>Data Management</h3>
                </div>
                <div class="card-body">
                    <button class="btn btn-outline" onclick="exportAllData()">üì• Export All Data (JSON)</button>
                    <button class="btn btn-outline" onclick="document.getElementById('importFile').click()">üì§ Import Data</button>
                    <input type="file" id="importFile" style="display: none;" accept=".json" onchange="importData(event)">
                    <button class="btn btn-outline" style="color: var(--danger);" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Document Form Modal -->
    <div class="modal-overlay" id="documentModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalTitle">New Quotation</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="documentForm">
                    <input type="hidden" id="docId">
                    <input type="hidden" id="docType">
                    
                    <!-- Document Header -->
                    <div class="doc-preview-header">
                        <div>
                            <div class="doc-type" id="docTypeLabel">Quotation</div>
                            <input type="text" class="doc-number-input" id="docNumber" placeholder="QT-26-XXXX">
                        </div>
                        <div class="doc-status">
                            <select id="docStatus">
                                <option value="draft">Draft</option>
                                <option value="sent">Sent</option>
                                <option value="confirmed">Confirmed</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Client Section -->
                    <div class="section-title">üë§ Client Information</div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Client <span class="required">*</span></label>
                            <select class="form-control" id="clientSelect" required onchange="onClientSelect()">
                                <option value="">Select client...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Contact Person</label>
                            <input type="text" class="form-control" id="contactPerson">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" class="form-control" id="clientEmail">
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="text" class="form-control" id="clientPhone">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Address</label>
                        <textarea class="form-control" id="clientAddress" rows="2"></textarea>
                    </div>
                    
                    <!-- Document Details -->
                    <div class="section-title">üìÑ Document Details</div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Date <span class="required">*</span></label>
                            <input type="date" class="form-control" id="docDate" required>
                        </div>
                        <div class="form-group" id="validTillGroup">
                            <label>Valid Till</label>
                            <input type="date" class="form-control" id="validTill">
                        </div>
                        <div class="form-group" id="customerPOGroup" style="display: none;">
                            <label>Customer PO Number</label>
                            <input type="text" class="form-control" id="customerPO">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Currency</label>
                            <select class="form-control" id="currency">
                                <option value="S$">SGD (S$)</option>
                                <option value="$">USD ($)</option>
                                <option value="‚Ç¨">EUR (‚Ç¨)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Sales Person</label>
                            <input type="text" class="form-control" id="salesPerson" value="Jerome">
                        </div>
                    </div>
                    
                    <!-- Line Items -->
                    <div class="section-title">üì¶ Products / Line Items</div>
                    
                    <table class="items-table">
                        <thead>
                            <tr>
                                <th style="width: 40px;">S/No</th>
                                <th style="width: 150px;">Product</th>
                                <th>Description</th>
                                <th style="width: 70px;">Qty</th>
                                <th style="width: 100px;">Unit Price</th>
                                <th style="width: 100px;">Amount</th>
                                <th style="width: 40px;"></th>
                            </tr>
                        </thead>
                        <tbody id="itemsBody"></tbody>
                    </table>
                    
                    <button type="button" class="btn-add-row" onclick="addLineItem()">+ Add Product Line</button>
                    
                    <div class="totals-section">
                        <div class="totals-box">
                            <div class="totals-row">
                                <span>Sub Total</span>
                                <span id="subtotal">S$ 0.00</span>
                            </div>
                            <div class="totals-row">
                                <span>Freight</span>
                                <span id="freight">S$ 0.00</span>
                            </div>
                            <div class="totals-row">
                                <span>GST (9%)</span>
                                <span id="gstAmount">S$ 0.00</span>
                            </div>
                            <div class="totals-row grand">
                                <span>Grand Total</span>
                                <span id="grandTotal">S$ 0.00</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Terms -->
                    <div class="section-title">üìù Terms & Conditions</div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Payment Term</label>
                            <select class="form-control" id="paymentTerm">
                                <option value="30 days">30 days</option>
                                <option value="45 days">45 days</option>
                                <option value="60 days">60 days</option>
                                <option value="COD">COD</option>
                                <option value="50% Deposit">50% Deposit, 50% before delivery</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Shipping Term</label>
                            <select class="form-control" id="shippingTerm">
                                <option value="Local Delivery">Local Delivery</option>
                                <option value="FOB">FOB</option>
                                <option value="CIF">CIF</option>
                                <option value="EXW">EXW</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Delivery Schedule</label>
                            <input type="text" class="form-control" id="deliverySchedule" placeholder="e.g., 60 days">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Remarks</label>
                        <textarea class="form-control" id="remarks" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
                <button class="btn btn-secondary" onclick="saveDocument()">üíæ Save</button>
                <button class="btn btn-primary" onclick="saveAndGeneratePDF()">üìÑ Save & Generate PDF</button>
            </div>
        </div>
    </div>

    <!-- Client Modal -->
    <div class="modal-overlay" id="clientModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3 id="clientModalTitle">Add Client</h3>
                <button class="modal-close" onclick="closeClientModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="clientForm">
                    <input type="hidden" id="editClientId">
                    <div class="form-group">
                        <label>Company Name <span class="required">*</span></label>
                        <input type="text" class="form-control" id="clientCompany" required>
                    </div>
                    <div class="form-group">
                        <label>Contact Person</label>
                        <input type="text" class="form-control" id="clientContactPerson">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" class="form-control" id="clientEmailInput">
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="text" class="form-control" id="clientPhoneInput">
                    </div>
                    <div class="form-group">
                        <label>Address</label>
                        <textarea class="form-control" id="clientAddressInput" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeClientModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveClient()">Save Client</button>
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div class="modal-overlay" id="productModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3 id="productModalTitle">Add Product</h3>
                <button class="modal-close" onclick="closeProductModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="productForm">
                    <input type="hidden" id="editProductId">
                    <div class="form-group">
                        <label>Product Name <span class="required">*</span></label>
                        <input type="text" class="form-control" id="productName" required>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea class="form-control" id="productDescription" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Unit Price</label>
                        <input type="number" class="form-control" id="productPrice" step="0.01">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeProductModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveProduct()">Save Product</button>
            </div>
        </div>
    </div>

    <script>
        const { jsPDF } = window.jspdf;
        
        // Data Store
        let data = {
            quotations: [],
            salesOrders: [],
            clients: [],
            products: [],
            counters: { quote: 1476, so: 1 },
            settings: {
                apiKey: '',
                locationId: '',
                webhook: ''
            }
        };
        
        // Load data from localStorage
        function loadData() {
            const saved = localStorage.getItem('vmf_data');
            if (saved) {
                data = { ...data, ...JSON.parse(saved) };
            }
            
            // Add default clients if empty
            if (data.clients.length === 0) {
                data.clients = [
                    { id: '1', name: 'ST Engineering Advanced Material Engineering Pte Ltd', contact: 'Sharon Ang', email: 'angsharon@stengg.com', phone: '64609650', address: '601 Rifle Range Road Singapore 588398' },
                    { id: '2', name: 'Sellier & Bellot a.s.', contact: 'Contact Person', email: 'contact@sb.com', phone: '+420 123 456', address: 'Lidick√° 667, 258 01 Vla≈°im, Czech Republic' },
                    { id: '3', name: 'JET AVIATION (ASIA PACIFIC) PTE LTD', contact: 'Tamy Poh', email: 'tamy.poh@jetaviation.com', phone: '+65 9739 1096', address: '1071 West Camp Road Seletar Airport 797799' },
                    { id: '4', name: 'DNATA', contact: 'Contact Person', email: 'contact@dnata.com', phone: '+65 1234 5684', address: 'Singapore' },
                    { id: '5', name: 'Bombardier', contact: 'Contact Person', email: 'contact@bombardier.com', phone: '+1 514 123 4567', address: 'Canada' }
                ];
            }
            
            // Add default products if empty
            if (data.products.length === 0) {
                data.products = [
                    { id: '1', name: 'M2A1 Metal Box', description: 'Military grade metal ammunition box', price: 6.80 },
                    { id: '2', name: 'High Visibility Vest', description: 'Reflective safety vest with customization', price: 28.00 },
                    { id: '3', name: 'Top Frame', description: '086-200026-I', price: 38.00 },
                    { id: '4', name: 'Intermediate Frame', description: '086-200027-G', price: 38.00 },
                    { id: '5', name: 'Bottom Frame', description: '086-200028-E', price: 38.00 }
                ];
            }
            
            saveData();
        }
        
        function saveData() {
            localStorage.setItem('vmf_data', JSON.stringify(data));
            updateCounts();
        }
        
        function updateCounts() {
            document.getElementById('quoteCount').textContent = data.quotations.length;
            document.getElementById('soCount').textContent = data.salesOrders.length;
            document.getElementById('statQuotes').textContent = data.quotations.length;
            document.getElementById('statSOs').textContent = data.salesOrders.length;
            
            const totalRevenue = [...data.quotations.filter(q => q.status === 'confirmed'), ...data.salesOrders.filter(s => s.status === 'confirmed')]
                .reduce((sum, d) => sum + (parseFloat(d.grandTotal?.replace(/[^0-9.-]/g, '')) || 0), 0);
            document.getElementById('statRevenue').textContent = 'S$ ' + totalRevenue.toFixed(2);
            
            const pending = data.quotations.filter(q => q.status === 'sent').length;
            document.getElementById('statPending').textContent = pending;
        }
        
        // Page Navigation
        function showPage(page) {
            document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
            document.getElementById('page-' + page).style.display = 'block';
            
            document.querySelectorAll('.sidebar-menu a').forEach(a => a.classList.remove('active'));
            document.querySelector(`.sidebar-menu a[onclick="showPage('${page}')"]`)?.classList.add('active');
            
            if (page === 'dashboard') renderRecentDocs();
            if (page === 'quotations') renderQuotations();
            if (page === 'salesorders') renderSalesOrders();
            if (page === 'clients') renderClients();
            if (page === 'products') renderProducts();
            if (page === 'settings') loadSettings();
        }
        
        // Render Tables
        function renderRecentDocs() {
            const allDocs = [
                ...data.quotations.map(q => ({ ...q, type: 'Quote' })),
                ...data.salesOrders.map(s => ({ ...s, type: 'SO' }))
            ].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 10);
            
            const tbody = document.querySelector('#recentDocsTable tbody');
            tbody.innerHTML = allDocs.length === 0 
                ? '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #6c757d;">No documents yet. Create your first quotation or sales order!</td></tr>'
                : allDocs.map(doc => `
                    <tr>
                        <td class="doc-number">${doc.docNumber}</td>
                        <td>${doc.type}</td>
                        <td>${doc.clientName || '-'}</td>
                        <td>${doc.grandTotal || '-'}</td>
                        <td>${formatDate(doc.date)}</td>
                        <td><span class="status status-${doc.status}">${doc.status}</span></td>
                        <td class="actions-cell">
                            <button class="btn btn-outline btn-icon" onclick="editDocument('${doc.type.toLowerCase() === 'quote' ? 'quote' : 'so'}', '${doc.id}')" title="Edit">‚úèÔ∏è</button>
                            <button class="btn btn-outline btn-icon" onclick="generatePDFById('${doc.type.toLowerCase() === 'quote' ? 'quote' : 'so'}', '${doc.id}')" title="PDF">üìÑ</button>
                        </td>
                    </tr>
                `).join('');
        }
        
        function renderQuotations() {
            const search = document.getElementById('searchQuotes')?.value.toLowerCase() || '';
            const status = document.getElementById('filterQuoteStatus')?.value || '';
            
            let filtered = data.quotations;
            if (search) filtered = filtered.filter(q => q.docNumber.toLowerCase().includes(search) || q.clientName?.toLowerCase().includes(search));
            if (status) filtered = filtered.filter(q => q.status === status);
            
            const tbody = document.querySelector('#quotationsTable tbody');
            tbody.innerHTML = filtered.length === 0
                ? '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #6c757d;">No quotations found</td></tr>'
                : filtered.map(q => `
                    <tr>
                        <td class="doc-number">${q.docNumber}</td>
                        <td>${q.clientName || '-'}</td>
                        <td>${q.grandTotal || '-'}</td>
                        <td>${formatDate(q.date)}</td>
                        <td>${formatDate(q.validTill)}</td>
                        <td><span class="status status-${q.status}">${q.status}</span></td>
                        <td class="actions-cell">
                            <button class="btn btn-outline btn-icon" onclick="editDocument('quote', '${q.id}')" title="Edit">‚úèÔ∏è</button>
                            <button class="btn btn-outline btn-icon" onclick="generatePDFById('quote', '${q.id}')" title="PDF">üìÑ</button>
                            <button class="btn btn-outline btn-icon" onclick="duplicateDocument('quote', '${q.id}')" title="Duplicate">üìã</button>
                            <button class="btn btn-outline btn-icon" onclick="deleteDocument('quote', '${q.id}')" title="Delete">üóëÔ∏è</button>
                        </td>
                    </tr>
                `).join('');
        }
        
        function renderSalesOrders() {
            const search = document.getElementById('searchSOs')?.value.toLowerCase() || '';
            const status = document.getElementById('filterSOStatus')?.value || '';
            
            let filtered = data.salesOrders;
            if (search) filtered = filtered.filter(s => s.docNumber.toLowerCase().includes(search) || s.clientName?.toLowerCase().includes(search));
            if (status) filtered = filtered.filter(s => s.status === status);
            
            const tbody = document.querySelector('#salesOrdersTable tbody');
            tbody.innerHTML = filtered.length === 0
                ? '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #6c757d;">No sales orders found</td></tr>'
                : filtered.map(s => `
                    <tr>
                        <td class="doc-number">${s.docNumber}</td>
                        <td>${s.clientName || '-'}</td>
                        <td>${s.customerPO || '-'}</td>
                        <td>${s.grandTotal || '-'}</td>
                        <td>${formatDate(s.date)}</td>
                        <td><span class="status status-${s.status}">${s.status}</span></td>
                        <td class="actions-cell">
                            <button class="btn btn-outline btn-icon" onclick="editDocument('so', '${s.id}')" title="Edit">‚úèÔ∏è</button>
                            <button class="btn btn-outline btn-icon" onclick="generatePDFById('so', '${s.id}')" title="PDF">üìÑ</button>
                            <button class="btn btn-outline btn-icon" onclick="duplicateDocument('so', '${s.id}')" title="Duplicate">üìã</button>
                            <button class="btn btn-outline btn-icon" onclick="deleteDocument('so', '${s.id}')" title="Delete">üóëÔ∏è</button>
                        </td>
                    </tr>
                `).join('');
        }
        
        function renderClients() {
            const tbody = document.querySelector('#clientsTable tbody');
            tbody.innerHTML = data.clients.map(c => `
                <tr>
                    <td>${c.name}</td>
                    <td>${c.contact || '-'}</td>
                    <td>${c.email || '-'}</td>
                    <td>${c.phone || '-'}</td>
                    <td class="actions-cell">
                        <button class="btn btn-outline btn-icon" onclick="editClient('${c.id}')" title="Edit">‚úèÔ∏è</button>
                        <button class="btn btn-outline btn-icon" onclick="deleteClient('${c.id}')" title="Delete">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function renderProducts() {
            const tbody = document.querySelector('#productsTable tbody');
            tbody.innerHTML = data.products.map(p => `
                <tr>
                    <td>${p.name}</td>
                    <td>${p.description || '-'}</td>
                    <td>S$ ${(p.price || 0).toFixed(2)}</td>
                    <td class="actions-cell">
                        <button class="btn btn-outline btn-icon" onclick="editProduct('${p.id}')" title="Edit">‚úèÔ∏è</button>
                        <button class="btn btn-outline btn-icon" onclick="deleteProduct('${p.id}')" title="Delete">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function filterDocuments(type) {
            if (type === 'quote') renderQuotations();
            else renderSalesOrders();
        }
        
        // Document Modal
        let currentDocType = 'quote';
        let itemCount = 0;
        
        function openNewDocument(type) {
            currentDocType = type;
            document.getElementById('docId').value = '';
            document.getElementById('docType').value = type;
            document.getElementById('modalTitle').textContent = type === 'quote' ? 'New Quotation' : 'New Sales Order';
            document.getElementById('docTypeLabel').textContent = type === 'quote' ? 'Quotation' : 'Sales Order';
            
            // Generate document number
            const year = new Date().getFullYear().toString().slice(-2);
            const month = (new Date().getMonth() + 1).toString().padStart(2, '0');
            if (type === 'quote') {
                document.getElementById('docNumber').value = `QT-${year}-${(data.counters.quote + 1).toString().padStart(4, '0')}`;
            } else {
                document.getElementById('docNumber').value = `VMF-${year}-${month}-${data.counters.so.toString().padStart(2, '0')}`;
            }
            
            // Show/hide fields
            document.getElementById('validTillGroup').style.display = type === 'quote' ? 'block' : 'none';
            document.getElementById('customerPOGroup').style.display = type === 'so' ? 'block' : 'none';
            
            // Reset form
            document.getElementById('documentForm').reset();
            document.getElementById('docDate').value = new Date().toISOString().split('T')[0];
            const validTill = new Date();
            validTill.setDate(validTill.getDate() + 30);
            document.getElementById('validTill').value = validTill.toISOString().split('T')[0];
            document.getElementById('salesPerson').value = 'Jerome';
            document.getElementById('docStatus').value = 'draft';
            
            // Clear items
            document.getElementById('itemsBody').innerHTML = '';
            itemCount = 0;
            addLineItem();
            
            // Populate client dropdown
            populateClientDropdown();
            
            document.getElementById('documentModal').classList.add('show');
        }
        
        function editDocument(type, id) {
            currentDocType = type;
            const doc = type === 'quote' 
                ? data.quotations.find(q => q.id === id)
                : data.salesOrders.find(s => s.id === id);
            
            if (!doc) return;
            
            document.getElementById('docId').value = doc.id;
            document.getElementById('docType').value = type;
            document.getElementById('modalTitle').textContent = type === 'quote' ? 'Edit Quotation' : 'Edit Sales Order';
            document.getElementById('docTypeLabel').textContent = type === 'quote' ? 'Quotation' : 'Sales Order';
            document.getElementById('docNumber').value = doc.docNumber;
            document.getElementById('docStatus').value = doc.status || 'draft';
            
            document.getElementById('validTillGroup').style.display = type === 'quote' ? 'block' : 'none';
            document.getElementById('customerPOGroup').style.display = type === 'so' ? 'block' : 'none';
            
            populateClientDropdown();
            
            // Fill form
            document.getElementById('clientSelect').value = doc.clientId || '';
            document.getElementById('contactPerson').value = doc.contactPerson || '';
            document.getElementById('clientEmail').value = doc.clientEmail || '';
            document.getElementById('clientPhone').value = doc.clientPhone || '';
            document.getElementById('clientAddress').value = doc.clientAddress || '';
            document.getElementById('docDate').value = doc.date || '';
            document.getElementById('validTill').value = doc.validTill || '';
            document.getElementById('customerPO').value = doc.customerPO || '';
            document.getElementById('currency').value = doc.currency || 'S$';
            document.getElementById('salesPerson').value = doc.salesPerson || 'Jerome';
            document.getElementById('paymentTerm').value = doc.paymentTerm || '30 days';
            document.getElementById('shippingTerm').value = doc.shippingTerm || 'Local Delivery';
            document.getElementById('deliverySchedule').value = doc.deliverySchedule || '';
            document.getElementById('remarks').value = doc.remarks || '';
            
            // Fill items
            document.getElementById('itemsBody').innerHTML = '';
            itemCount = 0;
            if (doc.items && doc.items.length > 0) {
                doc.items.forEach(item => {
                    addLineItem(item);
                });
            } else {
                addLineItem();
            }
            
            calculateTotals();
            document.getElementById('documentModal').classList.add('show');
        }
        
        function closeModal() {
            document.getElementById('documentModal').classList.remove('show');
        }
        
        function populateClientDropdown() {
            const select = document.getElementById('clientSelect');
            select.innerHTML = '<option value="">Select client...</option>' +
                data.clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }
        
        function onClientSelect() {
            const clientId = document.getElementById('clientSelect').value;
            const client = data.clients.find(c => c.id === clientId);
            if (client) {
                document.getElementById('contactPerson').value = client.contact || '';
                document.getElementById('clientEmail').value = client.email || '';
                document.getElementById('clientPhone').value = client.phone || '';
                document.getElementById('clientAddress').value = client.address || '';
            }
        }
        
        function addLineItem(item = null) {
            itemCount++;
            const tbody = document.getElementById('itemsBody');
            const tr = document.createElement('tr');
            tr.id = `row-${itemCount}`;
            tr.innerHTML = `
                <td>${itemCount}</td>
                <td>
                    <select class="form-control form-control-sm" onchange="onProductSelect(${itemCount}, this.value)">
                        <option value="">Select...</option>
                        ${data.products.map(p => `<option value="${p.id}" ${item?.productId === p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                        <option value="custom">Custom...</option>
                    </select>
                    <input type="text" class="form-control form-control-sm" id="customProduct-${itemCount}" placeholder="Product name" style="margin-top: 5px; display: ${item && !item.productId ? 'block' : 'none'};" value="${item?.customProduct || ''}">
                </td>
                <td>
                    <textarea class="form-control form-control-sm" id="desc-${itemCount}" rows="2">${item?.description || ''}</textarea>
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm num-input" id="qty-${itemCount}" value="${item?.qty || 1}" min="1" onchange="calcRow(${itemCount})">
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm num-input" id="price-${itemCount}" value="${item?.price || 0}" step="0.01" onchange="calcRow(${itemCount})">
                </td>
                <td class="amount-cell" id="amount-${itemCount}">${item?.amount || 'S$ 0.00'}</td>
                <td>
                    <button type="button" class="btn btn-outline btn-icon" onclick="removeRow(${itemCount})" style="color: var(--danger);">‚úï</button>
                </td>
            `;
            tbody.appendChild(tr);
            
            if (item?.productId) {
                onProductSelect(itemCount, item.productId, true);
            }
        }
        
        function onProductSelect(rowId, productId, skipPriceUpdate = false) {
            const customInput = document.getElementById(`customProduct-${rowId}`);
            if (productId === 'custom') {
                customInput.style.display = 'block';
                customInput.focus();
            } else if (productId) {
                customInput.style.display = 'none';
                const product = data.products.find(p => p.id === productId);
                if (product) {
                    document.getElementById(`desc-${rowId}`).value = product.description || '';
                    if (!skipPriceUpdate) {
                        document.getElementById(`price-${rowId}`).value = product.price || 0;
                    }
                    calcRow(rowId);
                }
            } else {
                customInput.style.display = 'none';
            }
        }
        
        function calcRow(rowId) {
            const qty = parseFloat(document.getElementById(`qty-${rowId}`)?.value) || 0;
            const price = parseFloat(document.getElementById(`price-${rowId}`)?.value) || 0;
            const amount = qty * price;
            const currency = document.getElementById('currency').value;
            document.getElementById(`amount-${rowId}`).textContent = `${currency} ${amount.toFixed(2)}`;
            calculateTotals();
        }
        
        function removeRow(rowId) {
            document.getElementById(`row-${rowId}`)?.remove();
            calculateTotals();
        }
        
        function calculateTotals() {
            let subtotal = 0;
            const currency = document.getElementById('currency').value;
            
            document.querySelectorAll('#itemsBody tr').forEach(row => {
                const amountEl = row.querySelector('.amount-cell');
                if (amountEl) {
                    const amount = parseFloat(amountEl.textContent.replace(/[^0-9.-]/g, '')) || 0;
                    subtotal += amount;
                }
            });
            
            const gst = subtotal * 0.09;
            const grandTotal = subtotal + gst;
            
            document.getElementById('subtotal').textContent = `${currency} ${subtotal.toFixed(2)}`;
            document.getElementById('gstAmount').textContent = `${currency} ${gst.toFixed(2)}`;
            document.getElementById('grandTotal').textContent = `${currency} ${grandTotal.toFixed(2)}`;
        }
        
        document.getElementById('currency').addEventListener('change', calculateTotals);
        
        function getFormData() {
            const items = [];
            document.querySelectorAll('#itemsBody tr').forEach((row, idx) => {
                const select = row.querySelector('select');
                const customInput = row.querySelector('input[id^="customProduct"]');
                const productId = select?.value;
                const productName = productId === 'custom' 
                    ? customInput?.value 
                    : data.products.find(p => p.id === productId)?.name || '';
                
                if (productName || productId === 'custom') {
                    items.push({
                        sno: idx + 1,
                        productId: productId !== 'custom' ? productId : null,
                        customProduct: productId === 'custom' ? customInput?.value : null,
                        product: productName || customInput?.value,
                        description: row.querySelector('textarea')?.value || '',
                        qty: parseFloat(row.querySelector('.num-input')?.value) || 0,
                        price: parseFloat(row.querySelectorAll('.num-input')[1]?.value) || 0,
                        amount: row.querySelector('.amount-cell')?.textContent || ''
                    });
                }
            });
            
            return {
                id: document.getElementById('docId').value || Date.now().toString(),
                type: document.getElementById('docType').value,
                docNumber: document.getElementById('docNumber').value,
                status: document.getElementById('docStatus').value,
                clientId: document.getElementById('clientSelect').value,
                clientName: document.getElementById('clientSelect').options[document.getElementById('clientSelect').selectedIndex]?.text || '',
                contactPerson: document.getElementById('contactPerson').value,
                clientEmail: document.getElementById('clientEmail').value,
                clientPhone: document.getElementById('clientPhone').value,
                clientAddress: document.getElementById('clientAddress').value,
                date: document.getElementById('docDate').value,
                validTill: document.getElementById('validTill').value,
                customerPO: document.getElementById('customerPO').value,
                currency: document.getElementById('currency').value,
                salesPerson: document.getElementById('salesPerson').value,
                items: items,
                subtotal: document.getElementById('subtotal').textContent,
                gst: document.getElementById('gstAmount').textContent,
                grandTotal: document.getElementById('grandTotal').textContent,
                paymentTerm: document.getElementById('paymentTerm').value,
                shippingTerm: document.getElementById('shippingTerm').value,
                deliverySchedule: document.getElementById('deliverySchedule').value,
                remarks: document.getElementById('remarks').value
            };
        }
        
        function saveDocument() {
            const formData = getFormData();
            
            if (!formData.clientName || formData.clientName === 'Select client...') {
                alert('Please select a client');
                return null;
            }
            
            const isEdit = document.getElementById('docId').value !== '';
            
            if (formData.type === 'quote') {
                if (isEdit) {
                    const idx = data.quotations.findIndex(q => q.id === formData.id);
                    if (idx >= 0) data.quotations[idx] = formData;
                } else {
                    data.quotations.push(formData);
                    data.counters.quote++;
                }
            } else {
                if (isEdit) {
                    const idx = data.salesOrders.findIndex(s => s.id === formData.id);
                    if (idx >= 0) data.salesOrders[idx] = formData;
                } else {
                    data.salesOrders.push(formData);
                    data.counters.so++;
                }
            }
            
            saveData();
            closeModal();
            showPage(formData.type === 'quote' ? 'quotations' : 'salesorders');
            return formData;
        }
        
        function saveAndGeneratePDF() {
            const formData = saveDocument();
            if (formData) {
                generatePDF(formData);
            }
        }
        
        function generatePDFById(type, id) {
            const doc = type === 'quote' 
                ? data.quotations.find(q => q.id === id)
                : data.salesOrders.find(s => s.id === id);
            if (doc) {
                doc.type = type;
                generatePDF(doc);
            }
        }
        
        function generatePDF(docData) {
            const doc = new jsPDF();
            const pageWidth = doc.internal.pageSize.width;
            const margin = 15;
            let y = 15;
            
            // Use consistent font
            doc.setFont('helvetica');
            
            // Date top right
            doc.setFontSize(9);
            doc.setTextColor(100);
            const dateStr = formatDate(docData.date);
            doc.text(dateStr, pageWidth - margin, y, { align: 'right' });
            
            y += 15;
            
            // Logo placeholder
            doc.setFillColor(232, 104, 37);
            doc.rect(margin, y, 10, 10, 'F');
            doc.setFontSize(6);
            doc.setTextColor(255);
            doc.text('VMF', margin + 5, y + 6, { align: 'center' });
            
            // Company name
            doc.setFontSize(8);
            doc.setTextColor(232, 104, 37);
            doc.setFont('helvetica', 'bold');
            doc.text('VIETNAM MANUFACTURING', margin + 14, y + 4);
            doc.text('FEDERATION', margin + 14, y + 8);
            
            // Company address right
            doc.setFontSize(8);
            doc.setTextColor(60);
            doc.setFont('helvetica', 'bold');
            doc.text('VM Federation Pte. Ltd.', pageWidth - margin, y, { align: 'right' });
            doc.setFont('helvetica', 'normal');
            doc.text('10 Ubi Crescent Lobby D, #01-65', pageWidth - margin, y + 4, { align: 'right' });
            doc.text('Ubi Techpark, Singapore 408564', pageWidth - margin, y + 8, { align: 'right' });
            doc.text('RCB & GST: 201704479Z', pageWidth - margin, y + 12, { align: 'right' });
            
            y += 22;
            
            // Line
            doc.setDrawColor(232, 104, 37);
            doc.setLineWidth(0.5);
            doc.line(margin, y, pageWidth - margin, y);
            
            y += 12;
            
            // Title
            doc.setFontSize(16);
            doc.setTextColor(40);
            doc.setFont('helvetica', 'bold');
            const title = docData.type === 'quote' ? 'QUOTATION' : 'ORDER CONFIRMATION';
            doc.text(title, pageWidth / 2, y, { align: 'center' });
            
            y += 12;
            
            // Two columns
            const colWidth = 80;
            
            // Left - Client
            doc.setFontSize(9);
            doc.setTextColor(100);
            doc.setFont('helvetica', 'bold');
            doc.text(docData.type === 'quote' ? 'QUOTE TO' : 'ATTENTION', margin, y);
            
            y += 5;
            doc.setTextColor(40);
            doc.text(docData.clientName || '', margin, y);
            doc.setFont('helvetica', 'normal');
            if (docData.contactPerson) { y += 4; doc.text(docData.contactPerson, margin, y); }
            if (docData.clientPhone) { y += 4; doc.text(docData.clientPhone, margin, y); }
            if (docData.clientEmail) { y += 4; doc.text(docData.clientEmail, margin, y); }
            if (docData.clientAddress) {
                const addrLines = doc.splitTextToSize(docData.clientAddress, colWidth);
                addrLines.forEach(line => { y += 4; doc.text(line, margin, y); });
            }
            
            // Right - Details
            let rightY = y - (docData.contactPerson ? 4 : 0) - (docData.clientPhone ? 4 : 0) - (docData.clientEmail ? 4 : 0);
            const rightX = pageWidth - margin - 60;
            
            doc.setFontSize(12);
            doc.setTextColor(232, 104, 37);
            doc.setFont('helvetica', 'bold');
            doc.text(docData.docNumber, pageWidth - margin, rightY, { align: 'right' });
            
            rightY += 8;
            doc.setFontSize(9);
            doc.setTextColor(100);
            doc.setFont('helvetica', 'normal');
            
            const details = [
                ['Date:', dateStr],
                docData.type === 'quote' ? ['Valid Till:', formatDate(docData.validTill)] : null,
                ['Currency:', docData.currency === 'S$' ? 'SGD' : docData.currency],
                docData.customerPO ? ['Your PO:', docData.customerPO] : null,
                docData.type === 'so' ? ['Our SO:', docData.docNumber] : null,
                ['Sales Person:', docData.salesPerson]
            ].filter(Boolean);
            
            details.forEach(([label, value]) => {
                doc.text(label, rightX, rightY);
                doc.setTextColor(40);
                doc.text(value || '', pageWidth - margin, rightY, { align: 'right' });
                doc.setTextColor(100);
                rightY += 5;
            });
            
            y = Math.max(y, rightY) + 10;
            
            // Items table
            const tableData = docData.items.map(item => [
                item.sno,
                item.product,
                item.description,
                item.qty,
                `${docData.currency} ${(item.price || 0).toFixed(2)}`,
                item.amount
            ]);
            
            doc.autoTable({
                startY: y,
                head: [['S/No', 'Product', 'Description', 'Qty', 'Unit Price', 'Amount']],
                body: tableData,
                theme: 'grid',
                styles: { font: 'helvetica', fontSize: 8 },
                headStyles: { fillColor: [27, 67, 50], textColor: 255, fontStyle: 'bold' },
                columnStyles: {
                    0: { cellWidth: 12, halign: 'center' },
                    1: { cellWidth: 35 },
                    2: { cellWidth: 55 },
                    3: { cellWidth: 15, halign: 'center' },
                    4: { cellWidth: 25, halign: 'right' },
                    5: { cellWidth: 28, halign: 'right' }
                },
                margin: { left: margin, right: margin }
            });
            
            y = doc.lastAutoTable.finalY + 10;
            
            // Totals
            const totalsX = pageWidth - margin - 55;
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            
            doc.setTextColor(100);
            doc.text('Sub Total', totalsX, y);
            doc.setTextColor(40);
            doc.text(docData.subtotal, pageWidth - margin, y, { align: 'right' });
            y += 5;
            
            doc.setTextColor(100);
            doc.text('Freight', totalsX, y);
            doc.setTextColor(40);
            doc.text(`${docData.currency} 0.00`, pageWidth - margin, y, { align: 'right' });
            y += 6;
            
            doc.setDrawColor(40);
            doc.line(totalsX - 5, y, pageWidth - margin, y);
            y += 5;
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('Grand Total', totalsX, y);
            doc.text(docData.grandTotal, pageWidth - margin, y, { align: 'right' });
            
            y += 15;
            
            // Terms
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(40);
            doc.text('Terms & Conditions', margin, y);
            y += 5;
            doc.setFont('helvetica', 'normal');
            doc.text(`Payment Term: ${docData.paymentTerm}`, margin, y); y += 4;
            doc.text(`Shipping Term: ${docData.shippingTerm}`, margin, y); y += 4;
            if (docData.deliverySchedule) { doc.text(`Delivery Schedule: ${docData.deliverySchedule}`, margin, y); y += 4; }
            
            // Footer
            doc.setFontSize(8);
            doc.setTextColor(150);
            doc.text(docData.docNumber, margin, doc.internal.pageSize.height - 10);
            
            doc.save(`${docData.docNumber}.pdf`);
        }
        
        function duplicateDocument(type, id) {
            const doc = type === 'quote' 
                ? data.quotations.find(q => q.id === id)
                : data.salesOrders.find(s => s.id === id);
            
            if (doc) {
                const newDoc = { ...doc, id: Date.now().toString(), status: 'draft' };
                
                // Generate new number
                const year = new Date().getFullYear().toString().slice(-2);
                const month = (new Date().getMonth() + 1).toString().padStart(2, '0');
                
                if (type === 'quote') {
                    data.counters.quote++;
                    newDoc.docNumber = `QT-${year}-${data.counters.quote.toString().padStart(4, '0')}`;
                    data.quotations.push(newDoc);
                } else {
                    data.counters.so++;
                    newDoc.docNumber = `VMF-${year}-${month}-${data.counters.so.toString().padStart(2, '0')}`;
                    data.salesOrders.push(newDoc);
                }
                
                saveData();
                showPage(type === 'quote' ? 'quotations' : 'salesorders');
            }
        }
        
        function deleteDocument(type, id) {
            if (confirm('Are you sure you want to delete this document?')) {
                if (type === 'quote') {
                    data.quotations = data.quotations.filter(q => q.id !== id);
                } else {
                    data.salesOrders = data.salesOrders.filter(s => s.id !== id);
                }
                saveData();
                showPage(type === 'quote' ? 'quotations' : 'salesorders');
            }
        }
        
        // Client Modal
        function openClientModal(id = null) {
            document.getElementById('clientForm').reset();
            document.getElementById('editClientId').value = '';
            document.getElementById('clientModalTitle').textContent = 'Add Client';
            
            if (id) {
                const client = data.clients.find(c => c.id === id);
                if (client) {
                    document.getElementById('editClientId').value = client.id;
                    document.getElementById('clientModalTitle').textContent = 'Edit Client';
                    document.getElementById('clientCompany').value = client.name;
                    document.getElementById('clientContactPerson').value = client.contact || '';
                    document.getElementById('clientEmailInput').value = client.email || '';
                    document.getElementById('clientPhoneInput').value = client.phone || '';
                    document.getElementById('clientAddressInput').value = client.address || '';
                }
            }
            
            document.getElementById('clientModal').classList.add('show');
        }
        
        function closeClientModal() {
            document.getElementById('clientModal').classList.remove('show');
        }
        
        function editClient(id) { openClientModal(id); }
        
        function saveClient() {
            const id = document.getElementById('editClientId').value || Date.now().toString();
            const client = {
                id,
                name: document.getElementById('clientCompany').value,
                contact: document.getElementById('clientContactPerson').value,
                email: document.getElementById('clientEmailInput').value,
                phone: document.getElementById('clientPhoneInput').value,
                address: document.getElementById('clientAddressInput').value
            };
            
            if (!client.name) { alert('Company name is required'); return; }
            
            const idx = data.clients.findIndex(c => c.id === id);
            if (idx >= 0) {
                data.clients[idx] = client;
            } else {
                data.clients.push(client);
            }
            
            saveData();
            closeClientModal();
            renderClients();
        }
        
        function deleteClient(id) {
            if (confirm('Delete this client?')) {
                data.clients = data.clients.filter(c => c.id !== id);
                saveData();
                renderClients();
            }
        }
        
        // Product Modal
        function openProductModal(id = null) {
            document.getElementById('productForm').reset();
            document.getElementById('editProductId').value = '';
            document.getElementById('productModalTitle').textContent = 'Add Product';
            
            if (id) {
                const product = data.products.find(p => p.id === id);
                if (product) {
                    document.getElementById('editProductId').value = product.id;
                    document.getElementById('productModalTitle').textContent = 'Edit Product';
                    document.getElementById('productName').value = product.name;
                    document.getElementById('productDescription').value = product.description || '';
                    document.getElementById('productPrice').value = product.price || 0;
                }
            }
            
            document.getElementById('productModal').classList.add('show');
        }
        
        function closeProductModal() {
            document.getElementById('productModal').classList.remove('show');
        }
        
        function editProduct(id) { openProductModal(id); }
        
        function saveProduct() {
            const id = document.getElementById('editProductId').value || Date.now().toString();
            const product = {
                id,
                name: document.getElementById('productName').value,
                description: document.getElementById('productDescription').value,
                price: parseFloat(document.getElementById('productPrice').value) || 0
            };
            
            if (!product.name) { alert('Product name is required'); return; }
            
            const idx = data.products.findIndex(p => p.id === id);
            if (idx >= 0) {
                data.products[idx] = product;
            } else {
                data.products.push(product);
            }
            
            saveData();
            closeProductModal();
            renderProducts();
        }
        
        function deleteProduct(id) {
            if (confirm('Delete this product?')) {
                data.products = data.products.filter(p => p.id !== id);
                saveData();
                renderProducts();
            }
        }
        
        // Settings
        function loadSettings() {
            document.getElementById('settingsApiKey').value = data.settings.apiKey || '';
            document.getElementById('settingsLocationId').value = data.settings.locationId || '';
            document.getElementById('settingsWebhook').value = data.settings.webhook || '';
            document.getElementById('settingsQuoteNum').value = data.counters.quote;
            document.getElementById('settingsSONum').value = data.counters.so;
        }
        
        function saveSettings() {
            data.settings.apiKey = document.getElementById('settingsApiKey').value;
            data.settings.locationId = document.getElementById('settingsLocationId').value;
            data.settings.webhook = document.getElementById('settingsWebhook').value;
            saveData();
            alert('Settings saved!');
            
            // Try to sync clients from Techflouu
            if (data.settings.apiKey && data.settings.locationId) {
                syncClients();
            }
        }
        
        function saveNumbering() {
            data.counters.quote = parseInt(document.getElementById('settingsQuoteNum').value) || data.counters.quote;
            data.counters.so = parseInt(document.getElementById('settingsSONum').value) || data.counters.so;
            saveData();
            alert('Numbering updated!');
        }
        
        async function syncClients() {
            try {
                const response = await fetch(`https://rest.gohighlevel.com/v1/contacts/?locationId=${data.settings.locationId}&limit=100`, {
                    headers: { 'Authorization': `Bearer ${data.settings.apiKey}` }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    const newClients = result.contacts.map(c => ({
                        id: c.id,
                        name: c.companyName || `${c.firstName || ''} ${c.lastName || ''}`.trim(),
                        contact: `${c.firstName || ''} ${c.lastName || ''}`.trim(),
                        email: c.email || '',
                        phone: c.phone || '',
                        address: c.address1 || ''
                    }));
                    
                    // Merge with existing (don't overwrite)
                    newClients.forEach(nc => {
                        if (!data.clients.find(c => c.id === nc.id)) {
                            data.clients.push(nc);
                        }
                    });
                    
                    saveData();
                    renderClients();
                    alert(`Synced ${newClients.length} clients from Techflouu CRM!`);
                }
            } catch (e) {
                console.error('Sync failed:', e);
                alert('Failed to sync clients. Check your API key and Location ID.');
            }
        }
        
        function exportAllData() {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `vmf_data_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }
        
        function importData(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const imported = JSON.parse(e.target.result);
                        data = { ...data, ...imported };
                        saveData();
                        alert('Data imported successfully!');
                        showPage('dashboard');
                    } catch (err) {
                        alert('Invalid file format');
                    }
                };
                reader.readAsText(file);
            }
        }
        
        function clearAllData() {
            if (confirm('‚ö†Ô∏è This will delete ALL data (quotations, sales orders, clients, products). Are you sure?')) {
                localStorage.removeItem('vmf_data');
                location.reload();
            }
        }
        
        // Helpers
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            return d.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }
        
        // Init
        loadData();
        showPage('dashboard');
    </script>
</body>
</html>
