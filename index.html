<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VM Federation - Document Manager</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --primary: #E86825; --secondary: #1B4332; --dark: #2c3e50; --light: #f8f9fa; --border: #dee2e6; --success: #28a745; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f0f2f5; min-height: 100vh; }
        
        .top-nav { background: var(--secondary); padding: 0 20px; display: flex; align-items: center; height: 56px; position: sticky; top: 0; z-index: 100; }
        .nav-brand { display: flex; align-items: center; gap: 10px; margin-right: 30px; }
        .nav-brand-icon { width: 34px; height: 34px; background: var(--primary); border-radius: 6px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 11px; }
        .nav-brand h1 { color: #fff; font-size: 15px; }
        .nav-menu { display: flex; gap: 5px; list-style: none; }
        .nav-menu a { display: flex; align-items: center; gap: 6px; padding: 8px 14px; color: rgba(255,255,255,0.7); text-decoration: none; font-size: 13px; border-radius: 6px; }
        .nav-menu a:hover, .nav-menu a.active { background: var(--primary); color: #fff; }
        .nav-menu .badge { background: rgba(255,255,255,0.2); padding: 2px 7px; border-radius: 10px; font-size: 11px; }
        .nav-right { margin-left: auto; display: flex; align-items: center; gap: 12px; }
        .nav-status { display: flex; align-items: center; gap: 5px; color: rgba(255,255,255,0.7); font-size: 11px; }
        .nav-status .dot { width: 8px; height: 8px; border-radius: 50%; background: #6c757d; }
        .nav-status .dot.ok { background: var(--success); }
        
        .main { padding: 20px 25px; max-width: 1300px; margin: 0 auto; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px; }
        .page-header h2 { font-size: 19px; color: var(--dark); }
        
        .btn { display: inline-flex; align-items: center; gap: 5px; padding: 9px 16px; border: none; border-radius: 6px; font-size: 13px; font-weight: 500; cursor: pointer; font-family: inherit; }
        .btn-primary { background: var(--primary); color: #fff; }
        .btn-primary:hover { background: #d55a1a; }
        .btn-secondary { background: var(--secondary); color: #fff; }
        .btn-outline { background: #fff; border: 1px solid var(--border); color: var(--dark); }
        .btn-sm { padding: 5px 10px; font-size: 12px; }
        .btn-icon { width: 30px; height: 30px; padding: 0; display: inline-flex; align-items: center; justify-content: center; }
        
        .card { background: #fff; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); margin-bottom: 18px; }
        .card-header { padding: 14px 18px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .card-header h3 { font-size: 14px; color: var(--dark); }
        .card-body { padding: 18px; }
        
        .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 18px; }
        .stat-card { background: #fff; border-radius: 10px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        .stat-card .label { font-size: 11px; color: #6c757d; text-transform: uppercase; }
        .stat-card .value { font-size: 24px; font-weight: 700; color: var(--dark); margin-top: 3px; }
        
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th { text-align: left; padding: 10px 14px; background: var(--light); color: #6c757d; font-size: 11px; font-weight: 600; text-transform: uppercase; border-bottom: 2px solid var(--border); }
        .data-table td { padding: 10px 14px; border-bottom: 1px solid var(--border); font-size: 13px; }
        .data-table tr:hover { background: #f8f9fa; }
        .doc-number { font-weight: 600; color: var(--primary); }
        .status { display: inline-block; padding: 3px 9px; border-radius: 20px; font-size: 11px; font-weight: 500; }
        .status-draft { background: #e9ecef; color: #6c757d; }
        .status-sent { background: #cce5ff; color: #004085; }
        .status-confirmed { background: #d4edda; color: #155724; }
        .actions-cell { display: flex; gap: 4px; }
        
        .toolbar { display: flex; gap: 12px; margin-bottom: 14px; flex-wrap: wrap; }
        .search-box { flex: 1; min-width: 180px; position: relative; }
        .search-box input { width: 100%; padding: 9px 12px 9px 34px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; font-family: inherit; }
        .search-box::before { content: 'üîç'; position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 13px; }
        
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 12px; }
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 12px; font-weight: 500; color: #495057; }
        .form-group label .req { color: #dc3545; }
        .form-control { width: 100%; padding: 9px 11px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; font-family: inherit; }
        .form-control:focus { outline: none; border-color: var(--primary); }
        select.form-control { appearance: none; background: #fff url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%236c757d' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E") no-repeat right 10px center; }
        textarea.form-control { resize: vertical; min-height: 60px; }
        .form-control-sm { padding: 6px 9px; font-size: 12px; }
        
        .section-title { font-size: 13px; font-weight: 600; color: var(--dark); margin: 18px 0 10px; padding-bottom: 6px; border-bottom: 2px solid var(--primary); }
        
        .doc-header { background: linear-gradient(135deg, var(--secondary), #0d2818); border-radius: 10px; padding: 18px; margin-bottom: 18px; display: flex; justify-content: space-between; align-items: center; }
        .doc-header .doc-type { color: rgba(255,255,255,0.7); font-size: 11px; text-transform: uppercase; }
        .doc-header .doc-num-input { background: transparent; border: 1px dashed rgba(255,255,255,0.3); color: var(--primary); font-size: 20px; font-weight: 700; font-family: inherit; padding: 4px 9px; border-radius: 6px; width: 190px; }
        .doc-header .doc-num-input:focus { outline: none; border-color: var(--primary); background: rgba(255,255,255,0.1); }
        .doc-header select { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 5px 10px; border-radius: 20px; font-size: 11px; font-family: inherit; }
        
        .items-table { width: 100%; border-collapse: collapse; margin: 8px 0; }
        .items-table th { background: var(--secondary); color: #fff; padding: 9px; text-align: left; font-size: 11px; font-weight: 600; }
        .items-table td { padding: 7px 9px; border-bottom: 1px solid var(--border); vertical-align: top; }
        .items-table input, .items-table textarea, .items-table select { width: 100%; padding: 7px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; font-family: inherit; }
        .items-table .num-input { width: 70px; text-align: right; }
        .items-table .amt-cell { font-weight: 600; color: var(--secondary); text-align: right; }
        .btn-add-row { width: 100%; padding: 9px; background: #f8f9fa; border: 2px dashed var(--border); color: #6c757d; border-radius: 6px; font-size: 12px; font-family: inherit; cursor: pointer; }
        .btn-add-row:hover { border-color: var(--primary); color: var(--primary); }
        
        .totals { display: flex; justify-content: flex-end; margin-top: 14px; }
        .totals-box { background: var(--light); padding: 14px 18px; border-radius: 8px; min-width: 240px; }
        .totals-row { display: flex; justify-content: space-between; padding: 4px 0; font-size: 13px; }
        .totals-row.grand { border-top: 2px solid var(--dark); margin-top: 6px; padding-top: 8px; font-weight: 700; font-size: 15px; color: var(--primary); }
        
        .modal-bg { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: flex-start; justify-content: center; padding: 20px; overflow-y: auto; }
        .modal-bg.show { display: flex; }
        .modal { background: #fff; border-radius: 12px; width: 100%; max-width: 820px; margin: 20px auto; }
        .modal-header { padding: 16px 18px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { font-size: 16px; font-weight: 600; }
        .modal-close { background: none; border: none; font-size: 20px; color: #6c757d; cursor: pointer; }
        .modal-body { padding: 18px; max-height: 68vh; overflow-y: auto; }
        .modal-footer { padding: 14px 18px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 8px; }
        
        .settings-section { background: var(--light); padding: 14px; border-radius: 8px; margin-bottom: 14px; }
        .settings-section h4 { font-size: 13px; margin-bottom: 10px; color: var(--dark); }
        
        .alert { padding: 11px 14px; border-radius: 6px; margin-bottom: 14px; font-size: 13px; }
        .alert-warning { background: #fff3cd; color: #856404; border: 1px solid #ffc107; }
        .alert-success { background: #d4edda; color: #155724; }
        
        .empty { text-align: center; padding: 40px 20px; color: #6c757d; }
        .empty .icon { font-size: 36px; margin-bottom: 10px; }
        .empty h4 { font-size: 15px; margin-bottom: 5px; color: var(--dark); }
        .empty p { font-size: 13px; }
        
        @media (max-width: 768px) { .nav-menu { display: none; } .form-row { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <nav class="top-nav">
        <div class="nav-brand">
            <div class="nav-brand-icon">VMF</div>
            <h1>Document Manager</h1>
        </div>
        <ul class="nav-menu">
            <li><a href="#" class="active" onclick="showPage('dashboard',this)">üìä Dashboard</a></li>
            <li><a href="#" onclick="showPage('quotes',this)">üìã Quotations <span class="badge" id="qCnt">0</span></a></li>
            <li><a href="#" onclick="showPage('orders',this)">üì¶ Sales Orders <span class="badge" id="sCnt">0</span></a></li>
        </ul>
        <div class="nav-right">
            <div class="nav-status"><span class="dot" id="conDot"></span><span id="conTxt">Not configured</span></div>
            <button class="btn btn-outline btn-sm" onclick="openSettings()">‚öôÔ∏è Settings</button>
        </div>
    </nav>

    <main class="main">
        <div id="pg-dashboard" class="page">
            <div class="page-header">
                <h2>Dashboard</h2>
                <div style="display:flex;gap:8px;">
                    <button class="btn btn-primary" onclick="openDoc('quote')">+ New Quotation</button>
                    <button class="btn btn-secondary" onclick="openDoc('so')">+ New Sales Order</button>
                </div>
            </div>
            <div id="cfgAlert" class="alert alert-warning" style="display:none;">‚ö†Ô∏è Configure Techflouu CRM in <a href="#" onclick="openSettings()">Settings</a> to load clients & products.</div>
            <div class="stats-row">
                <div class="stat-card"><div class="label">Quotations</div><div class="value" id="sQ">0</div></div>
                <div class="stat-card"><div class="label">Sales Orders</div><div class="value" id="sS">0</div></div>
                <div class="stat-card"><div class="label">Clients (CRM)</div><div class="value" id="sC">-</div></div>
                <div class="stat-card"><div class="label">Products (CRM)</div><div class="value" id="sP">-</div></div>
            </div>
            <div class="card">
                <div class="card-header"><h3>Recent Documents</h3></div>
                <div class="card-body" style="padding:0;"><table class="data-table" id="tblRecent"><thead><tr><th>Doc #</th><th>Type</th><th>Client</th><th>Amount</th><th>Date</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table></div>
            </div>
        </div>

        <div id="pg-quotes" class="page" style="display:none;">
            <div class="page-header"><h2>Quotations</h2><button class="btn btn-primary" onclick="openDoc('quote')">+ New Quotation</button></div>
            <div class="toolbar">
                <div class="search-box"><input type="text" placeholder="Search..." id="srcQ" onkeyup="renderQ()"></div>
                <select class="form-control" style="width:130px;" id="fltQ" onchange="renderQ()"><option value="">All Status</option><option value="draft">Draft</option><option value="sent">Sent</option><option value="confirmed">Confirmed</option></select>
            </div>
            <div class="card"><div class="card-body" style="padding:0;"><table class="data-table" id="tblQ"><thead><tr><th>Quote #</th><th>Client</th><th>Amount</th><th>Date</th><th>Valid Till</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table></div></div>
        </div>

        <div id="pg-orders" class="page" style="display:none;">
            <div class="page-header"><h2>Sales Orders</h2><button class="btn btn-primary" onclick="openDoc('so')">+ New Sales Order</button></div>
            <div class="toolbar">
                <div class="search-box"><input type="text" placeholder="Search..." id="srcS" onkeyup="renderS()"></div>
                <select class="form-control" style="width:130px;" id="fltS" onchange="renderS()"><option value="">All Status</option><option value="draft">Draft</option><option value="confirmed">Confirmed</option></select>
            </div>
            <div class="card"><div class="card-body" style="padding:0;"><table class="data-table" id="tblS"><thead><tr><th>SO #</th><th>Client</th><th>Cust PO</th><th>Amount</th><th>Date</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table></div></div>
        </div>
    </main>

    <div class="modal-bg" id="docModal">
        <div class="modal">
            <div class="modal-header"><h3 id="mTitle">New Quotation</h3><button class="modal-close" onclick="closeDoc()">&times;</button></div>
            <div class="modal-body">
                <form id="docForm">
                    <input type="hidden" id="dId"><input type="hidden" id="dType">
                    <div class="doc-header">
                        <div><div class="doc-type" id="dLabel">Quotation</div><input type="text" class="doc-num-input" id="dNum" placeholder="QT-26-XXXX"></div>
                        <select id="dStatus"><option value="draft">Draft</option><option value="sent">Sent</option><option value="confirmed">Confirmed</option></select>
                    </div>
                    <div class="section-title">üë§ Client (from Techflouu CRM)</div>
                    <div class="form-row">
                        <div class="form-group"><label>Client <span class="req">*</span></label><select class="form-control" id="dClient" required onchange="onClient()"><option value="">Loading...</option></select></div>
                        <div class="form-group"><label>Contact Person</label><input type="text" class="form-control" id="dContact" readonly></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Email</label><input type="email" class="form-control" id="dEmail" readonly></div>
                        <div class="form-group"><label>Phone</label><input type="text" class="form-control" id="dPhone" readonly></div>
                    </div>
                    <div class="form-group"><label>Address</label><textarea class="form-control" id="dAddr" rows="2" readonly></textarea></div>
                    <div class="section-title">üìÑ Document Details</div>
                    <div class="form-row">
                        <div class="form-group"><label>Date <span class="req">*</span></label><input type="date" class="form-control" id="dDate" required></div>
                        <div class="form-group" id="grpValid"><label>Valid Till</label><input type="date" class="form-control" id="dValid"></div>
                        <div class="form-group" id="grpPO" style="display:none;"><label>Customer PO #</label><input type="text" class="form-control" id="dCustPO"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Currency</label><select class="form-control" id="dCurr"><option value="S$">SGD (S$)</option><option value="$">USD ($)</option><option value="‚Ç¨">EUR (‚Ç¨)</option></select></div>
                        <div class="form-group"><label>Sales Person</label><input type="text" class="form-control" id="dSales" value="Jerome"></div>
                    </div>
                    <div class="section-title">üì¶ Products (from Techflouu CRM)</div>
                    <table class="items-table"><thead><tr><th style="width:30px;">#</th><th style="width:140px;">Product</th><th>Description</th><th style="width:60px;">Qty</th><th style="width:85px;">Price</th><th style="width:90px;">Amount</th><th style="width:30px;"></th></tr></thead><tbody id="itemsBody"></tbody></table>
                    <button type="button" class="btn-add-row" onclick="addItem()">+ Add Product</button>
                    <div class="totals"><div class="totals-box">
                        <div class="totals-row"><span>Sub Total</span><span id="tSub">S$ 0.00</span></div>
                        <div class="totals-row"><span>Freight</span><span>S$ 0.00</span></div>
                        <div class="totals-row"><span>GST (9%)</span><span id="tGst">S$ 0.00</span></div>
                        <div class="totals-row grand"><span>Grand Total</span><span id="tGrand">S$ 0.00</span></div>
                    </div></div>
                    <div class="section-title">üìù Terms</div>
                    <div class="form-row">
                        <div class="form-group"><label>Payment</label><select class="form-control" id="dPay"><option>30 days</option><option>45 days</option><option>60 days</option><option>COD</option></select></div>
                        <div class="form-group"><label>Shipping</label><select class="form-control" id="dShip"><option>Local Delivery</option><option>FOB</option><option>CIF</option></select></div>
                        <div class="form-group"><label>Delivery</label><input type="text" class="form-control" id="dDeliv" placeholder="e.g., 60 days"></div>
                    </div>
                    <div class="form-group"><label>Remarks</label><textarea class="form-control" id="dRemarks" rows="2"></textarea></div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeDoc()">Cancel</button>
                <button class="btn btn-secondary" onclick="saveDoc()">üíæ Save</button>
                <button class="btn btn-primary" onclick="saveAndPDF()">üìÑ Save & PDF</button>
            </div>
        </div>
    </div>

    <div class="modal-bg" id="setModal">
        <div class="modal" style="max-width:500px;">
            <div class="modal-header"><h3>‚öôÔ∏è Settings</h3><button class="modal-close" onclick="closeSettings()">&times;</button></div>
            <div class="modal-body">
                <div class="settings-section">
                    <h4>üîó Techflouu CRM</h4>
                    <div class="form-group"><label>API Key <span class="req">*</span></label><input type="text" class="form-control" id="setApi" placeholder="API Key"></div>
                    <div class="form-group"><label>Location ID <span class="req">*</span></label><input type="text" class="form-control" id="setLoc" placeholder="Location ID"></div>
                    <p style="font-size:11px;color:#6c757d;margin-top:6px;">Clients (tagged "client"), Products, Vendors (tagged "vendor") loaded from CRM.</p>
                </div>
                <div class="settings-section">
                    <h4>‚òÅÔ∏è Cloud Save (n8n)</h4>
                    <div class="form-group"><label>Webhook URL</label><input type="text" class="form-control" id="setHook" placeholder="https://your-n8n.com/webhook/..."></div>
                    <p style="font-size:11px;color:#6c757d;">PDFs saved to OneDrive, Techflouu CRM, Asana.</p>
                </div>
                <div class="settings-section">
                    <h4>üî¢ Numbering</h4>
                    <div class="form-row">
                        <div class="form-group"><label>Next Quote #</label><input type="number" class="form-control" id="setQNum"></div>
                        <div class="form-group"><label>Next SO #</label><input type="number" class="form-control" id="setSNum"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-outline" onclick="closeSettings()">Cancel</button><button class="btn btn-primary" onclick="saveSets()">Save & Connect</button></div>
        </div>
    </div>

<script>
const { jsPDF } = window.jspdf;
let D = { quotes: [], orders: [], cnt: { q: 1476, s: 1 }, set: { api: '', loc: '', hook: '' } };
let CRM = { clients: [], products: [], ok: false };

function load() {
    const s = localStorage.getItem('vmf3');
    if (s) D = { ...D, ...JSON.parse(s) };
    upStats();
    upCon();
    if (D.set.api && D.set.loc) loadCRM();
    else document.getElementById('cfgAlert').style.display = 'block';
}
function save() { localStorage.setItem('vmf3', JSON.stringify(D)); upStats(); }
function upStats() {
    document.getElementById('qCnt').textContent = D.quotes.length;
    document.getElementById('sCnt').textContent = D.orders.length;
    document.getElementById('sQ').textContent = D.quotes.length;
    document.getElementById('sS').textContent = D.orders.length;
    document.getElementById('sC').textContent = CRM.clients.length || '-';
    document.getElementById('sP').textContent = CRM.products.length || '-';
}
function upCon() {
    const d = document.getElementById('conDot'), t = document.getElementById('conTxt');
    if (!D.set.api) { d.className = 'dot'; t.textContent = 'Not configured'; }
    else if (CRM.ok) { d.className = 'dot ok'; t.textContent = 'Connected'; }
    else { d.className = 'dot'; t.textContent = 'Connecting...'; }
}

async function loadCRM() {
    if (!D.set.api || !D.set.loc) return;
    upCon();
    try {
        const r = await fetch(`https://rest.gohighlevel.com/v1/contacts/?locationId=${D.set.loc}&limit=100`, { headers: { 'Authorization': `Bearer ${D.set.api}` } });
        if (r.ok) {
            const d = await r.json();
            CRM.clients = d.contacts.filter(c => c.tags?.some(t => t.toLowerCase() === 'client')).map(c => ({
                id: c.id, name: c.companyName || `${c.firstName||''} ${c.lastName||''}`.trim(), contact: `${c.firstName||''} ${c.lastName||''}`.trim(),
                email: c.email || '', phone: c.phone || '', address: [c.address1, c.city, c.country].filter(Boolean).join(', ')
            }));
        }
        const r2 = await fetch(`https://rest.gohighlevel.com/v1/products/?locationId=${D.set.loc}`, { headers: { 'Authorization': `Bearer ${D.set.api}` } });
        if (r2.ok) {
            const d2 = await r2.json();
            CRM.products = (d2.products || []).map(p => ({ id: p._id || p.id, name: p.name, desc: p.description || '', price: p.amount || p.price || 0 }));
        }
        CRM.ok = true;
        document.getElementById('cfgAlert').style.display = 'none';
    } catch (e) { console.error(e); CRM.ok = false; }
    upCon(); upStats();
}

function showPage(p, el) {
    document.querySelectorAll('.page').forEach(x => x.style.display = 'none');
    document.getElementById('pg-' + p).style.display = 'block';
    document.querySelectorAll('.nav-menu a').forEach(a => a.classList.remove('active'));
    if (el) el.classList.add('active');
    if (p === 'dashboard') renderRecent();
    if (p === 'quotes') renderQ();
    if (p === 'orders') renderS();
}

function renderRecent() {
    const all = [...D.quotes.map(q => ({ ...q, tp: 'Quote' })), ...D.orders.map(s => ({ ...s, tp: 'SO' }))].sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0)).slice(0, 10);
    document.querySelector('#tblRecent tbody').innerHTML = all.length === 0 ? '<tr><td colspan="7" class="empty"><div class="icon">üìÑ</div><h4>No documents</h4></td></tr>' : all.map(d => `<tr><td class="doc-number">${d.num || '-'}</td><td>${d.tp}</td><td>${d.client || '-'}</td><td>${d.grand || '-'}</td><td>${fmtD(d.date)}</td><td><span class="status status-${d.status||'draft'}">${d.status||'draft'}</span></td><td class="actions-cell"><button class="btn btn-outline btn-icon btn-sm" onclick="editDoc('${d.tp==='Quote'?'quote':'so'}','${d.id}')">‚úèÔ∏è</button><button class="btn btn-outline btn-icon btn-sm" onclick="pdfById('${d.tp==='Quote'?'quote':'so'}','${d.id}')">üìÑ</button></td></tr>`).join('');
}
function renderQ() {
    const src = (document.getElementById('srcQ')?.value || '').toLowerCase(), flt = document.getElementById('fltQ')?.value || '';
    let f = D.quotes;
    if (src) f = f.filter(q => (q.num || '').toLowerCase().includes(src) || (q.client || '').toLowerCase().includes(src));
    if (flt) f = f.filter(q => q.status === flt);
    document.querySelector('#tblQ tbody').innerHTML = f.length === 0 ? '<tr><td colspan="7" class="empty">No quotations</td></tr>' : f.map(q => `<tr><td class="doc-number">${q.num||'-'}</td><td>${q.client||'-'}</td><td>${q.grand||'-'}</td><td>${fmtD(q.date)}</td><td>${fmtD(q.valid)}</td><td><span class="status status-${q.status||'draft'}">${q.status||'draft'}</span></td><td class="actions-cell"><button class="btn btn-outline btn-icon btn-sm" onclick="editDoc('quote','${q.id}')">‚úèÔ∏è</button><button class="btn btn-outline btn-icon btn-sm" onclick="pdfById('quote','${q.id}')">üìÑ</button><button class="btn btn-outline btn-icon btn-sm" onclick="delDoc('quote','${q.id}')">üóëÔ∏è</button></td></tr>`).join('');
}
function renderS() {
    const src = (document.getElementById('srcS')?.value || '').toLowerCase(), flt = document.getElementById('fltS')?.value || '';
    let f = D.orders;
    if (src) f = f.filter(s => (s.num || '').toLowerCase().includes(src) || (s.client || '').toLowerCase().includes(src));
    if (flt) f = f.filter(s => s.status === flt);
    document.querySelector('#tblS tbody').innerHTML = f.length === 0 ? '<tr><td colspan="7" class="empty">No sales orders</td></tr>' : f.map(s => `<tr><td class="doc-number">${s.num||'-'}</td><td>${s.client||'-'}</td><td>${s.custPO||'-'}</td><td>${s.grand||'-'}</td><td>${fmtD(s.date)}</td><td><span class="status status-${s.status||'draft'}">${s.status||'draft'}</span></td><td class="actions-cell"><button class="btn btn-outline btn-icon btn-sm" onclick="editDoc('so','${s.id}')">‚úèÔ∏è</button><button class="btn btn-outline btn-icon btn-sm" onclick="pdfById('so','${s.id}')">üìÑ</button><button class="btn btn-outline btn-icon btn-sm" onclick="delDoc('so','${s.id}')">üóëÔ∏è</button></td></tr>`).join('');
}

let iCnt = 0;
function openDoc(tp) {
    document.getElementById('dId').value = '';
    document.getElementById('dType').value = tp;
    document.getElementById('mTitle').textContent = tp === 'quote' ? 'New Quotation' : 'New Sales Order';
    document.getElementById('dLabel').textContent = tp === 'quote' ? 'Quotation' : 'Sales Order';
    const y = new Date().getFullYear().toString().slice(-2), m = (new Date().getMonth() + 1).toString().padStart(2, '0');
    document.getElementById('dNum').value = tp === 'quote' ? `QT-${y}-${(D.cnt.q + 1).toString().padStart(4, '0')}` : `VMF-${y}-${m}-${D.cnt.s.toString().padStart(2, '0')}`;
    document.getElementById('grpValid').style.display = tp === 'quote' ? 'block' : 'none';
    document.getElementById('grpPO').style.display = tp === 'so' ? 'block' : 'none';
    document.getElementById('docForm').reset();
    document.getElementById('dDate').value = new Date().toISOString().split('T')[0];
    const vd = new Date(); vd.setDate(vd.getDate() + 30);
    document.getElementById('dValid').value = vd.toISOString().split('T')[0];
    document.getElementById('dSales').value = 'Jerome';
    document.getElementById('dStatus').value = 'draft';
    popClients();
    document.getElementById('itemsBody').innerHTML = '';
    iCnt = 0; addItem();
    document.getElementById('docModal').classList.add('show');
}
function editDoc(tp, id) {
    const doc = tp === 'quote' ? D.quotes.find(q => q.id === id) : D.orders.find(s => s.id === id);
    if (!doc) return;
    document.getElementById('dId').value = doc.id;
    document.getElementById('dType').value = tp;
    document.getElementById('mTitle').textContent = tp === 'quote' ? 'Edit Quotation' : 'Edit Sales Order';
    document.getElementById('dLabel').textContent = tp === 'quote' ? 'Quotation' : 'Sales Order';
    document.getElementById('dNum').value = doc.num || '';
    document.getElementById('dStatus').value = doc.status || 'draft';
    document.getElementById('grpValid').style.display = tp === 'quote' ? 'block' : 'none';
    document.getElementById('grpPO').style.display = tp === 'so' ? 'block' : 'none';
    popClients();
    document.getElementById('dClient').value = doc.clientId || '';
    document.getElementById('dContact').value = doc.contact || '';
    document.getElementById('dEmail').value = doc.email || '';
    document.getElementById('dPhone').value = doc.phone || '';
    document.getElementById('dAddr').value = doc.addr || '';
    document.getElementById('dDate').value = doc.date || '';
    document.getElementById('dValid').value = doc.valid || '';
    document.getElementById('dCustPO').value = doc.custPO || '';
    document.getElementById('dCurr').value = doc.curr || 'S$';
    document.getElementById('dSales').value = doc.sales || '';
    document.getElementById('dPay').value = doc.pay || '30 days';
    document.getElementById('dShip').value = doc.ship || 'Local Delivery';
    document.getElementById('dDeliv').value = doc.deliv || '';
    document.getElementById('dRemarks').value = doc.remarks || '';
    document.getElementById('itemsBody').innerHTML = '';
    iCnt = 0;
    (doc.items || []).forEach(i => addItem(i));
    if (!doc.items?.length) addItem();
    calcTotals();
    document.getElementById('docModal').classList.add('show');
}
function closeDoc() { document.getElementById('docModal').classList.remove('show'); }

function popClients() {
    const sel = document.getElementById('dClient');
    sel.innerHTML = CRM.clients.length > 0 ? '<option value="">Select client...</option>' + CRM.clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('') : '<option value="">No clients - check CRM settings</option>';
}
function onClient() {
    const c = CRM.clients.find(x => x.id === document.getElementById('dClient').value);
    if (c) {
        document.getElementById('dContact').value = c.contact || '';
        document.getElementById('dEmail').value = c.email || '';
        document.getElementById('dPhone').value = c.phone || '';
        document.getElementById('dAddr').value = c.address || '';
    }
}

function addItem(it = null) {
    iCnt++;
    const tb = document.getElementById('itemsBody');
    const tr = document.createElement('tr');
    tr.id = `row-${iCnt}`;
    const opts = CRM.products.length > 0 ? CRM.products.map(p => `<option value="${p.id}" ${it?.pId === p.id ? 'selected' : ''}>${p.name}</option>`).join('') : '';
    tr.innerHTML = `<td>${iCnt}</td><td><select class="form-control-sm" onchange="onProd(${iCnt},this.value)"><option value="">Select...</option>${opts}<option value="custom" ${it && !it.pId ? 'selected' : ''}>Custom</option></select><input type="text" class="form-control-sm" id="cust-${iCnt}" style="margin-top:4px;display:${it && !it.pId ? 'block' : 'none'};" value="${it?.cust || ''}" placeholder="Product name"></td><td><textarea class="form-control-sm" id="desc-${iCnt}" rows="2">${it?.desc || ''}</textarea></td><td><input type="number" class="form-control-sm num-input" id="qty-${iCnt}" value="${it?.qty || 1}" min="1" onchange="calcRow(${iCnt})"></td><td><input type="number" class="form-control-sm num-input" id="prc-${iCnt}" value="${it?.price || 0}" step="0.01" onchange="calcRow(${iCnt})"></td><td class="amt-cell" id="amt-${iCnt}">${it?.amt || 'S$ 0.00'}</td><td><button type="button" class="btn btn-outline btn-icon btn-sm" onclick="delRow(${iCnt})" style="color:#dc3545;">‚úï</button></td>`;
    tb.appendChild(tr);
    if (it?.pId) onProd(iCnt, it.pId, true);
}
function onProd(r, v, skip = false) {
    const ci = document.getElementById(`cust-${r}`);
    if (v === 'custom') { ci.style.display = 'block'; }
    else if (v) {
        ci.style.display = 'none';
        const p = CRM.products.find(x => x.id === v);
        if (p) {
            document.getElementById(`desc-${r}`).value = p.desc || '';
            if (!skip) document.getElementById(`prc-${r}`).value = p.price || 0;
            calcRow(r);
        }
    } else { ci.style.display = 'none'; }
}
function calcRow(r) {
    const q = parseFloat(document.getElementById(`qty-${r}`)?.value) || 0;
    const p = parseFloat(document.getElementById(`prc-${r}`)?.value) || 0;
    const c = document.getElementById('dCurr').value;
    document.getElementById(`amt-${r}`).textContent = `${c} ${(q * p).toFixed(2)}`;
    calcTotals();
}
function delRow(r) { document.getElementById(`row-${r}`)?.remove(); calcTotals(); }
function calcTotals() {
    let sub = 0;
    const c = document.getElementById('dCurr').value;
    document.querySelectorAll('#itemsBody tr').forEach(tr => {
        const a = parseFloat(tr.querySelector('.amt-cell')?.textContent.replace(/[^0-9.-]/g, '')) || 0;
        sub += a;
    });
    const gst = sub * 0.09;
    document.getElementById('tSub').textContent = `${c} ${sub.toFixed(2)}`;
    document.getElementById('tGst').textContent = `${c} ${gst.toFixed(2)}`;
    document.getElementById('tGrand').textContent = `${c} ${(sub + gst).toFixed(2)}`;
}
document.getElementById('dCurr').addEventListener('change', calcTotals);

function getForm() {
    const items = [];
    document.querySelectorAll('#itemsBody tr').forEach((tr, i) => {
        const sel = tr.querySelector('select');
        const pId = sel?.value;
        const cust = tr.querySelector('input[id^="cust"]')?.value;
        const pName = pId === 'custom' ? cust : CRM.products.find(p => p.id === pId)?.name || cust || '';
        if (pName) items.push({
            sno: i + 1, pId: pId !== 'custom' ? pId : null, cust: pId === 'custom' ? cust : null, prod: pName,
            desc: tr.querySelector('textarea')?.value || '',
            qty: parseFloat(tr.querySelector('.num-input')?.value) || 0,
            price: parseFloat(tr.querySelectorAll('.num-input')[1]?.value) || 0,
            amt: tr.querySelector('.amt-cell')?.textContent || ''
        });
    });
    const cId = document.getElementById('dClient').value;
    const cl = CRM.clients.find(c => c.id === cId);
    return {
        id: document.getElementById('dId').value || Date.now().toString(),
        type: document.getElementById('dType').value,
        num: document.getElementById('dNum').value,
        status: document.getElementById('dStatus').value,
        clientId: cId, client: cl?.name || '', techId: cId,
        contact: document.getElementById('dContact').value,
        email: document.getElementById('dEmail').value,
        phone: document.getElementById('dPhone').value,
        addr: document.getElementById('dAddr').value,
        date: document.getElementById('dDate').value,
        valid: document.getElementById('dValid').value,
        custPO: document.getElementById('dCustPO').value,
        curr: document.getElementById('dCurr').value,
        sales: document.getElementById('dSales').value,
        items, sub: document.getElementById('tSub').textContent,
        gst: document.getElementById('tGst').textContent,
        grand: document.getElementById('tGrand').textContent,
        pay: document.getElementById('dPay').value,
        ship: document.getElementById('dShip').value,
        deliv: document.getElementById('dDeliv').value,
        remarks: document.getElementById('dRemarks').value
    };
}

function saveDoc() {
    const f = getForm();
    if (!f.client) { alert('Select a client'); return null; }
    const edit = !!document.getElementById('dId').value;
    if (f.type === 'quote') {
        if (edit) { const i = D.quotes.findIndex(q => q.id === f.id); if (i >= 0) D.quotes[i] = f; }
        else { D.quotes.push(f); D.cnt.q++; }
    } else {
        if (edit) { const i = D.orders.findIndex(s => s.id === f.id); if (i >= 0) D.orders[i] = f; }
        else { D.orders.push(f); D.cnt.s++; }
    }
    save(); closeDoc();
    showPage(f.type === 'quote' ? 'quotes' : 'orders');
    return f;
}
function saveAndPDF() { const f = saveDoc(); if (f) makePDF(f); }
function pdfById(tp, id) {
    const d = tp === 'quote' ? D.quotes.find(q => q.id === id) : D.orders.find(s => s.id === id);
    if (d) { d.type = tp; makePDF(d); }
}
function delDoc(tp, id) {
    if (!confirm('Delete?')) return;
    if (tp === 'quote') D.quotes = D.quotes.filter(q => q.id !== id);
    else D.orders = D.orders.filter(s => s.id !== id);
    save(); showPage(tp === 'quote' ? 'quotes' : 'orders');
}

function makePDF(d) {
    const pdf = new jsPDF();
    const pw = pdf.internal.pageSize.width, m = 15;
    let y = 15;
    pdf.setFont('helvetica');
    pdf.setFontSize(9); pdf.setTextColor(100);
    pdf.text(fmtD(d.date), pw - m, y, { align: 'right' });
    y += 15;
    pdf.setFillColor(232, 104, 37); pdf.rect(m, y, 10, 10, 'F');
    pdf.setFontSize(6); pdf.setTextColor(255); pdf.text('VMF', m + 5, y + 6, { align: 'center' });
    pdf.setFontSize(8); pdf.setTextColor(232, 104, 37); pdf.setFont('helvetica', 'bold');
    pdf.text('VIETNAM MANUFACTURING', m + 14, y + 4); pdf.text('FEDERATION', m + 14, y + 8);
    pdf.setFontSize(8); pdf.setTextColor(60); pdf.setFont('helvetica', 'bold');
    pdf.text('VM Federation Pte. Ltd.', pw - m, y, { align: 'right' });
    pdf.setFont('helvetica', 'normal');
    pdf.text('10 Ubi Crescent Lobby D, #01-65', pw - m, y + 4, { align: 'right' });
    pdf.text('Singapore 408564', pw - m, y + 8, { align: 'right' });
    y += 22;
    pdf.setDrawColor(232, 104, 37); pdf.setLineWidth(0.5); pdf.line(m, y, pw - m, y);
    y += 12;
    pdf.setFontSize(16); pdf.setTextColor(40); pdf.setFont('helvetica', 'bold');
    pdf.text(d.type === 'quote' ? 'QUOTATION' : 'ORDER CONFIRMATION', pw / 2, y, { align: 'center' });
    y += 12;
    pdf.setFontSize(9); pdf.setTextColor(100); pdf.setFont('helvetica', 'bold');
    pdf.text(d.type === 'quote' ? 'QUOTE TO' : 'ATTENTION', m, y);
    y += 5; pdf.setTextColor(40); pdf.text(d.client || '', m, y);
    pdf.setFont('helvetica', 'normal');
    if (d.contact) { y += 4; pdf.text(d.contact, m, y); }
    if (d.phone) { y += 4; pdf.text(d.phone, m, y); }
    if (d.email) { y += 4; pdf.text(d.email, m, y); }
    let ry = y - 13;
    pdf.setFontSize(12); pdf.setTextColor(232, 104, 37); pdf.setFont('helvetica', 'bold');
    pdf.text(d.num, pw - m, ry, { align: 'right' });
    ry += 8; pdf.setFontSize(9); pdf.setTextColor(100); pdf.setFont('helvetica', 'normal');
    [['Date:', fmtD(d.date)], d.type === 'quote' ? ['Valid:', fmtD(d.valid)] : null, ['Currency:', d.curr], d.custPO ? ['Your PO:', d.custPO] : null, ['Sales:', d.sales]].filter(Boolean).forEach(([l, v]) => {
        pdf.text(l, pw - m - 50, ry); pdf.setTextColor(40); pdf.text(v || '', pw - m, ry, { align: 'right' }); pdf.setTextColor(100); ry += 5;
    });
    y = Math.max(y, ry) + 10;
    pdf.autoTable({
        startY: y,
        head: [['#', 'Product', 'Description', 'Qty', 'Price', 'Amount']],
        body: d.items.map(i => [i.sno, i.prod, i.desc, i.qty, `${d.curr} ${(i.price || 0).toFixed(2)}`, i.amt]),
        theme: 'grid', styles: { font: 'helvetica', fontSize: 8 },
        headStyles: { fillColor: [27, 67, 50], textColor: 255, fontStyle: 'bold' },
        columnStyles: { 0: { cellWidth: 10 }, 1: { cellWidth: 35 }, 2: { cellWidth: 55 }, 3: { cellWidth: 15, halign: 'center' }, 4: { cellWidth: 25, halign: 'right' }, 5: { cellWidth: 28, halign: 'right' } },
        margin: { left: m, right: m }
    });
    y = pdf.lastAutoTable.finalY + 10;
    const tx = pw - m - 55;
    pdf.setFontSize(9); pdf.setTextColor(100);
    pdf.text('Sub Total', tx, y); pdf.setTextColor(40); pdf.text(d.sub, pw - m, y, { align: 'right' }); y += 5;
    pdf.setTextColor(100); pdf.text('Freight', tx, y); pdf.text(`${d.curr} 0.00`, pw - m, y, { align: 'right' }); y += 6;
    pdf.line(tx - 5, y, pw - m, y); y += 5;
    pdf.setFontSize(10); pdf.setFont('helvetica', 'bold'); pdf.setTextColor(40);
    pdf.text('Grand Total', tx, y); pdf.text(d.grand, pw - m, y, { align: 'right' }); y += 15;
    pdf.setFontSize(9); pdf.setFont('helvetica', 'bold'); pdf.text('Terms', m, y); y += 5;
    pdf.setFont('helvetica', 'normal');
    pdf.text(`Payment: ${d.pay}  |  Shipping: ${d.ship}${d.deliv ? '  |  Delivery: ' + d.deliv : ''}`, m, y);
    pdf.setFontSize(8); pdf.setTextColor(150); pdf.text(d.num, m, pdf.internal.pageSize.height - 10);
    const b64 = pdf.output('datauristring');
    pdf.save(`${d.num}.pdf`);
    if (D.set.hook) {
        fetch(D.set.hook, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ...d, pdfBase64: b64 }) })
            .then(r => r.ok && alert('‚úÖ PDF saved to OneDrive, Techflouu CRM & Asana!')).catch(console.error);
    }
}

function openSettings() {
    document.getElementById('setApi').value = D.set.api || '';
    document.getElementById('setLoc').value = D.set.loc || '';
    document.getElementById('setHook').value = D.set.hook || '';
    document.getElementById('setQNum').value = D.cnt.q;
    document.getElementById('setSNum').value = D.cnt.s;
    document.getElementById('setModal').classList.add('show');
}
function closeSettings() { document.getElementById('setModal').classList.remove('show'); }
function saveSets() {
    D.set.api = document.getElementById('setApi').value;
    D.set.loc = document.getElementById('setLoc').value;
    D.set.hook = document.getElementById('setHook').value;
    D.cnt.q = parseInt(document.getElementById('setQNum').value) || D.cnt.q;
    D.cnt.s = parseInt(document.getElementById('setSNum').value) || D.cnt.s;
    save(); closeSettings(); loadCRM();
}

function fmtD(d) { return d ? new Date(d).toLocaleDateString('en-GB') : '-'; }
load(); showPage('dashboard');
</script>
</body>
</html>
